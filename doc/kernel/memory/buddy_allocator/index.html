<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `buddy_allocator` mod in crate `kernel`."><meta name="keywords" content="rust, rustlang, rust-lang, buddy_allocator"><title>kernel::memory::buddy_allocator - Rust</title><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../dark.css"><link rel="stylesheet" type="text/css" href="../../../light.css" id="themeStyle"><script src="../../../storage.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="shortcut icon" href="../../../favicon.ico"><style type="text/css">#crate-search{background-image:url("../../../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../../../kernel/index.html'><div class='logo-container'><img src='../../../rust-logo.png' alt='logo'></div></a><p class='location'>Module buddy_allocator</p><div class="sidebar-elems"><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#constants">Constants</a></li></ul></div><p class='location'><a href='../../index.html'>kernel</a>::<wbr><a href='../index.html'>memory</a></p><script>window.sidebarCurrent = {name: 'buddy_allocator', ty: 'mod', relpath: '../'};</script><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../../../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../../../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><a id="settings-menu" href="../../../settings.html"><img src="../../../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../../../src/kernel/memory/buddy_allocator.rs.html#1-220' title='goto source code'>[src]</a></span><span class='in-band'>Module <a href='../../index.html'>kernel</a>::<wbr><a href='../index.html'>memory</a>::<wbr><a class="mod" href=''>buddy_allocator</a></span></h1><div class='docblock'><p>This module implements a buddy allocator, an efficient scheme for managing physical memory. In
this allocator, memory is broken up into a number of blocks, each of which is a power-of-2 frames in
size. A block of size <code>2^^n</code> frames is said to be of order <code>n</code>:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
  <span class="number">16</span>                               <span class="number">0</span>       <span class="ident">Order</span>       <span class="ident">Size</span> <span class="ident">of</span> <span class="ident">blocks</span>
   <span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span>
   <span class="op">|</span>               <span class="number">8</span>               <span class="op">|</span>       <span class="number">4</span>           <span class="number">2</span><span class="op">^</span><span class="op">^</span><span class="number">4</span> <span class="op">=</span> <span class="number">16</span>
   <span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span>
   <span class="op">|</span>      <span class="number">12</span>       <span class="op">|</span>       <span class="number">4</span>       <span class="op">|</span>       <span class="number">3</span>           <span class="number">2</span><span class="op">^</span><span class="op">^</span><span class="number">3</span> <span class="op">=</span> <span class="number">8</span>
   <span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span>
   <span class="op">|</span>  <span class="number">14</span>   <span class="op">|</span>  <span class="number">10</span>   <span class="op">|</span>   <span class="number">6</span>   <span class="op">|</span>   <span class="number">2</span>   <span class="op">|</span>       <span class="number">2</span>           <span class="number">2</span><span class="op">^</span><span class="op">^</span><span class="number">2</span> <span class="op">=</span> <span class="number">4</span>
   <span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">|</span>
   <span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>       <span class="number">1</span>           <span class="number">2</span><span class="op">^</span><span class="op">^</span><span class="number">1</span> <span class="op">=</span> <span class="number">2</span>
   <span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span>
   <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span> <span class="op">|</span>       <span class="number">0</span>           <span class="number">2</span><span class="op">^</span><span class="op">^</span><span class="number">0</span> <span class="op">=</span> <span class="number">1</span>
   <span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span><span class="op">-</span><span class="op">|</span></pre></div>
<p>The blocks in each order are arranged in pairs - each has a &quot;buddy&quot; where A's buddy is B and B's
buddy is A. To find the address of a block's buddy, the bit corresponding to the order is simply
flipped (and so is easily calculated with XOR - see the <code>buddy_of</code> method). Blocks are tracked in
bins, where each bin contains blocks of a single order.</p>
<p>When an allocation is requested, the allocator looks in the bin of the correct size. If a block
is available, that block is removed from the bin and returned. If no blocks of the correct size
are available, a block of the order above the one requested is removed from its bin, split into
two blocks of the order requested (which are &quot;buddies&quot; of each other), of which one is returned
and one is added to the correct bin. If no blocks of the larger order are available, this
process continues recursively upwards to larger and larger block sizes, until a free block is
found. If no block is found, an &quot;out of memory&quot; error is issued.</p>
<p>When a block is &quot;freed&quot; (returned to the allocator so that it can be allocated again), the
allocator checks to see if its &quot;buddy&quot; is also free. If it's not, the block is just added to the
bin corresponding to its order. However, if its buddy is also free, the two can be merged to form
a block of an order one greater - this process happens recursively until the block's buddy is not
free, at which point the block is added to the correct bin.</p>
<p>Overall, the buddy allocator is an efficient allocator that has a much lower cost than other
algorithms such as first-fit. It also helps reduce external fragmentation, but can suffer from
internal fragmentation in the case of allocations that are slightly larger than a block size
(e.g. allocating 17 frames actually returns 32, wasting 15 frames). If the kernel needs to make
many allocations of a constant, &quot;known bad&quot; size (e.g. 3 frames at a time), it would be better
served allocating a larger block of frames at a time, and using a slab allocator to make the
individual allocations.</p>
</div><h2 id='structs' class='section-header'><a href="#structs">Structs</a></h2>
<table><tr class='module-item'><td><a class="struct" href="struct.BuddyAllocator.html" title='kernel::memory::buddy_allocator::BuddyAllocator struct'>BuddyAllocator</a></td><td class='docblock-short'></td></tr></table><h2 id='constants' class='section-header'><a href="#constants">Constants</a></h2>
<table><tr class='module-item'><td><a class="constant" href="constant.BASE_SIZE.html" title='kernel::memory::buddy_allocator::BASE_SIZE constant'>BASE_SIZE</a></td><td class='docblock-short'><p>The &quot;base&quot; block size - the smallest block size this allocator tracks. This is chosen at the moment to be 4096
bytes - the size of the smallest physical frame for all the architectures we wish to support at this point of
time.</p>
</td></tr><tr class='module-item'><td><a class="constant" href="constant.MAX_ORDER.html" title='kernel::memory::buddy_allocator::MAX_ORDER constant'>MAX_ORDER</a></td><td class='docblock-short'><p>The largest block stored by the buddy allocator is <code>2^MAX_ORDER</code>.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../../../";window.currentCrate = "kernel";</script><script src="../../../aliases.js"></script><script src="../../../main.js"></script><script defer src="../../../search-index.js"></script></body></html>